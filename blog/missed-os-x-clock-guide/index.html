<!DOCTYPE html>
<html lang="en-US">

<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="chrome=1">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer">
<meta name="author" content="Dmitriy Shilin">
<meta name="description" content="Table of contents
 Preface Motivation High resolution time management in Linux Mach Kernel Mach Clock API Deprecated Mach Clock API Links  Preface This is a story of a little fight with an obscure OS X clock API.
When it comes to high-resolution time management in OS X wouldn&rsquo;t it be a dreamy to have the following routines:
 Receive current monotonically incrementing time value. Sleep for a specified interval.">

<meta property="og:title" content="Missed OS X Clock Guide" />
<meta property="og:description" content="Table of contents
 Preface Motivation High resolution time management in Linux Mach Kernel Mach Clock API Deprecated Mach Clock API Links  Preface This is a story of a little fight with an obscure OS X clock API.
When it comes to high-resolution time management in OS X wouldn&rsquo;t it be a dreamy to have the following routines:
 Receive current monotonically incrementing time value. Sleep for a specified interval." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://dshil.github.io/blog/missed-os-x-clock-guide/" />
<meta property="article:published_time" content="2017-11-26T08:03:19&#43;03:00"/>
<meta property="article:modified_time" content="2017-11-26T08:03:19&#43;03:00"/>


<title>


     Missed OS X Clock Guide 

</title>
<link rel="canonical" href="https://dshil.github.io/blog/missed-os-x-clock-guide/">







<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.11.0/styles/default.min.css">




<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,700|Ubuntu+Mono:400,400i,700,700i|Raleway:500">



    
    <link rel="stylesheet" href="https://dshil.github.io/css/reset.css?t=2019-07-10%2010%3a42%3a12.231907337%20%2b0300%20MSK%20m%3d%2b0.034943586">
    <link rel="stylesheet" href="https://dshil.github.io/css/pygments.css?t=2019-07-10%2010%3a42%3a12.231907337%20%2b0300%20MSK%20m%3d%2b0.034943586">
    <link rel="stylesheet" href="https://dshil.github.io/css/main.css?t=2019-07-10%2010%3a42%3a12.231907337%20%2b0300%20MSK%20m%3d%2b0.034943586">
    




<link rel="shortcut icon"

    href="https://dshil.github.io/img/favicon.ico"

>








</head>


<body lang="en">

<section class="header">
    <div class="container">
        <div class="content">
            
                
                
                
                
                
                    
                
                
                <a href="https://dshil.github.io/"><img class="avatar" src="https://dshil.github.io/images/profile.png" srcset="https://dshil.github.io/images/profile.png 1x"></a>
            
            <a href="https://dshil.github.io/"><div class="name">Dmitriy Shilin</div></a>
            
              <h3 class="self-intro">Various notes about Software Development</h3>
            
            <nav>
                <ul>
                    
                        <li class="nav-blog"><a href="https://dshil.github.io/blog/"><span>Blog</span></a></li>
                    
                        <li class="nav-projects"><a href="https://dshil.github.io/projects/"><span>Projects</span></a></li>
                    
                        <li class="nav-talks"><a href="https://dshil.github.io/talks/"><span>Talks</span></a></li>
                    
                </ul>
            </nav>
        </div>
    </div>
</section>

<section class="icons">
    <div class="container">
        <div class="content">
        
            <a href="http://github.com/dshil" target="_blank" rel="noopener"><img class="icon" src="https://dshil.github.io/img/github.svg" alt="github" /></a>
        

        

        

	

        

        

        
            <a href="https://www.linkedin.com/in/dmitriy-shilin-10032a8b" target="_blank" rel="noopener"><img class="icon" src="https://dshil.github.io/img/linkedin.svg" alt="linkedin" /></a>
        

        

        

        

        

        

        
            <a href="mailto:dshil@fastmail.com"><img class="icon" src="https://dshil.github.io/img/email.svg" alt="email" /></a>
        

        

        
        </div>
    </div>
</section>


<section class="main post non-narrow zero-top-spacing">
    <div class="container">
        <div class="content">
            <div class="front-matter">
                <div class="title-container">
                    <div class="page-heading">

    Missed OS X Clock Guide

</div>

                    <div class="initials"><a href="https://dshil.github.io/"></a></div>
                </div>
                <div class="meta">
                    
                    <div class="date" title='Sun Nov 26 2017 08:03:19 MSK'>Nov 26, 2017</div>
                    
                    
		    <div class="reading-time"><div class="middot"></div>7 minutes read</div>
                    
                </div>
            </div>
            <div class="markdown">
                

<p><strong>Table of contents</strong></p>

<ul>
<li><a href="#preface">Preface</a></li>
<li><a href="#motivation">Motivation</a></li>
<li><a href="#linux">High resolution time management in Linux</a></li>
<li><a href="#mach-kernel">Mach Kernel</a></li>
<li><a href="#mach-clock-api">Mach Clock API</a></li>
<li><a href="#deprecated-mach-clock-api">Deprecated Mach Clock API</a></li>
<li><a href="#links">Links</a></li>
</ul>

<h2 id="preface">Preface</h2>

<p>This is a story of a little fight with an obscure OS X clock API.</p>

<p>When it comes to high-resolution time management in OS X wouldn&rsquo;t it be
a dreamy to have the following routines:</p>

<ul>
<li>Receive current monotonically incrementing time value.</li>
<li>Sleep for a specified interval.</li>
<li>Sleep until a specified time.</li>
</ul>

<h2 id="motivation">Motivation</h2>

<p>This fight was begun when I tried to make time-related operations portable in
<a href="https://github.com/roc-project/roc">Roc</a>.</p>

<p><strong>Thanks</strong></p>

<p>I would like to thank my friends and colleagues:</p>

<ul>
<li><a href="https://gavv.github.io/about/">Victor Gaydov</a> and <a href="https://github.com/roc-project/roc">his project</a>,
 that was a reason why this article has appeared and for dozen helpful
 advices how to improve this article.</li>
</ul>

<h2 id="linux">Linux</h2>

<p>Linux provides the following routines for high resolution clock management:</p>

<ul>
<li><a href="http://man7.org/linux/man-pages/man2/clock_nanosleep.2.html">clock_nanosleep</a></li>
<li><a href="http://man7.org/linux/man-pages/man2/nanosleep.2.html">nanosleep</a></li>
</ul>

<p>You probably shouldn&rsquo;t be afraid if <code>clock_nanosleep</code> isn&rsquo;t implemented on
your system, you can use <a href="http://man7.org/linux/man-pages/man2/gettimeofday.2.html">gettimeofday</a>
and <code>nanosleep</code>, but you&rsquo;ll lose a precision and the monotony because of
<code>gettimeofday</code>. You should test it first and maybe it will be acceptable in
your case.</p>

<p>As you remember this article isn&rsquo;t about Linux and to figure out how OS X clock
API actually works, we need to dig into OS X architecture a little.</p>

<h2 id="mach-kernel">Mach Kernel</h2>

<p><a href="https://en.wikipedia.org/wiki/XNU">XNU</a> (X is not UNIX) is OS X kernel.
It is constructed from two distinct parts: BSD interface used to build
POSIX API; Mach interface to handle processes, threads, virtual memory, and
scheduling. XNU is a <a href="https://en.wikipedia.org/wiki/Hybrid_kernel">hybrid kernel</a>.</p>

<p>Mach kernel was heavily reworked in release 3 (1993) and became a pure kernel,
moving the BSD part into the user space. Excluding UNIX-specific code from the
kernel allows to easily replace BSD with another operating system or even
running several <del>Linux</del> operating system interfaces simultaneously on the top
of the Mach kernel.</p>

<p>Mach design is all about IPC (inter-process communication mechanism), it is
called Mach Ports. Whenever you want to use some kernel or user space
facilities, you need to send a message to some port. Mach ensures security
by requiring that message senders and receivers have rights. A right consists
of a port name and a capability to send or receive on that port, and is much
like a capability in object-oriented systems. Only one task may receive
messages on a corresponding port, but many tasks may send messages to this port.
Mach port is very similar to a Linux file descriptor.</p>

<h2 id="mach-clock-api">Mach Clock API</h2>

<p>There are 3 ways to work with time in OSX:</p>

<ul>
<li>API based on <code>mach_timespec_t</code></li>
<li>API based on <code>AbsoluteTime</code></li>
<li><code>clock_gettime</code>, that was introduced in OS X Siera, but there aren&rsquo;t any
 news about <code>clock_nanosleep</code> introduction. It won&rsquo;t be dicsussed in this
 article.</li>
</ul>

<p><strong>API based on mach_timespec_t</strong></p>

<p>By exploring <a href="https://github.com/apple/darwin-xnu/tree/master/osfmk/man">man pages in XNU repository</a>, we can figure out, that Mach API has something called clock_service.</p>

<p>Let&rsquo;s explore what we can do with it:</p>

<pre><code class="language-c">#include &lt;mach/mach.h&gt;      /* host_get_clock_service */
#include &lt;mach/clock.h&gt;     /* clock_get_time */
#include &lt;mach/mach_error.h&gt; /* error handling */

kern_return_t err = KERN_SUCCESS;
clock_serv_t host_clock;

// mach/clock_types.h
//
// kern_return_t
// host_get_clock_service(
//     host_t			host,
//     clock_id_t		clock_id,
//     clock_t			*clock)
//
// Reserved clock id values for default clocks.
//
// #define SYSTEM_CLOCK	    	0
// #define CALENDAR_CLOCK		1
// #define REALTIME_CLOCK		0
//
// Where `clock_id` is the identification of the desired kernel clock with
// possible values:
//
//    - REALTIME_CLOCK stands for a time since a boot time. It has the same
//      semantic as CLOCK_MONOTONIC.
//
//    - BATTERY_CLOCK - (typically) low resolution clock that survives
//      power failures or service outages.
//
//    - HIGHRES_CLOCK - a high resolution clock.
//
// This function returns a send right to a kernel clock's service port.
err = host_get_clock_service(mach_host_self(), SYSTEM_CLOCK, &amp;host_clock);
if (err != KERN_SUCCESS) {
    mach_error(&quot;host_get_clock_service: &quot;, err);
    exit(EXIT_FAILURE);
}

// struct mach_timespec {
//    unsigned int  tv_sec;         /* seconds */
//    clock_res_t   tv_nsec;    /* nanoseconds */
// };
// typedef struct mach_timespec mach_timespec_t;
//
// As you can see, mach_timespec_t is the same as timespec in Linux.
mach_timespec_t now;

err = clock_get_time(host_clock, &amp;now);
if (err != KERN_SUCCESS) {
    mach_error(&quot;clock_get_time: &quot;, err);
    exit(EXIT_FAILURE);
}

// We should deallocate the port returned by host_get_clock_service,
// because we no longer need it.
//
// You should be careful with mach ports allocation and deallocation,
// because it is usually can cause the ports leak problem.
err = mach_port_deallocate(mach_task_self(), host_clock);
if (err != KERN_SUCCESS) {
    mach_error(&quot;mach_port_deallocate: &quot;, err);
    exit(EXIT_FAILURE);
}
</code></pre>

<p>Mach API also provides a system call similar to <code>clock_nanosleep</code>. It is called
<a href="https://github.com/apple/darwin-xnu/blob/master/osfmk/kern/clock_oldops.c#L493">clock_sleep</a>.</p>

<p>For more details about Mach API I recommend to use the following resources:</p>

<ul>
<li>OSF Mach Kernel Principles</li>
<li>OSF Mach Kernel Interfaces</li>
<li><a href="https://github.com/apple/darwin-xnu/tree/master/osfmk/man">XNU man pages</a></li>
<li><a href="http://web.mit.edu/darwin/src/modules/xnu/osfmk/man/">XNU man pages from MIT</a></li>
</ul>

<p>It&rsquo;s worth to mention, that API based on <code>mach_timespec_t</code> is
<a href="https://developer.apple.com/library/content/documentation/Darwin/Conceptual/KernelProgramming/Mach/Mach.html#//apple_ref/doc/uid/TP30000905-CH209-TPXREF111">deprecated</a>.  The
possible reasons are discussed in <a href="#deprecated-mach-clock-api">Deprecated Mach clock API</a>
section.</p>

<p><strong>API based on AbsoluteTime</strong></p>

<p>Apple explains hight resolution clock management in the following articles:</p>

<ul>
<li><a href="https://developer.apple.com/library/content/technotes/tn2169/_index.html">High Precision Timers in iOS / OS X</a></li>
<li><a href="https://developer.apple.com/library/content/qa/qa1398/_index.html">Mach Absolute Time Units</a></li>
</ul>

<p>We are recommended to use <code>mach_absolute_time</code> function.</p>

<p><code>mach_absolute_time</code> returns a Mach Time unit - clock ticks. The length of a
tick is a CPU dependent. On most Intel CPUs it probably will be 1 nanoseconds
per tick, but we shouldn&rsquo;t rely on this fact. The kernel provides a
transformation factor that can be used to convert abstract Mach time units to
nanoseconds.</p>

<p>Example of receiving current time in nanoseconds using <code>mach_absolute_time</code>:</p>

<pre><code class="language-c">
#include &lt;mach/mach_time.h&gt; /* mach_absolute_time */

mach_timebase_info_data_t info;

kern_return_t ret = mach_timebase_info(&amp;info);
if (ret != KERN_SUCCESS) {
    // Some kind of disaster...
}

// You should cache this value to avoid calculating it each time.
double steady_factor = (double) info.numer / info.denom;

uint64_t now_ns = mach_absolute_time() * steady_factor;
</code></pre>

<p><strong>Mach APIs under the hood</strong></p>

<p>Let&rsquo;s try to receive current time using both APIs:</p>

<ul>
<li><code>mach_timespec_t</code>: 556680752418861 ns</li>
<li><code>mach_absolute_time</code>: 55668752378055 ns</li>
</ul>

<p>Both values belongs to the same time domain.</p>

<ul>
<li><p>API based on <code>mach_absolute_time</code> uses <a href="https://en.wikipedia.org/wiki/Time_Stamp_Counter">RDTSC</a> underneath.
You can review <a href="https://opensource.apple.com/source/Libc/Libc-320.1.3/i386/mach/mach_absolute_time.c">source</a>
for more details.</p></li>

<li><p>API based on <code>mach_timespec_t</code> uses RDTSC through Mach ports.</p></li>
</ul>

<h2 id="deprecated-mach-clock-api">Deprecated Mach Clock API</h2>

<p>There are problems with time API based on <code>mach_timespec_t</code>. To receive the
current time you need 3 system calls:</p>

<ul>
<li>host_get_clock_service</li>
<li>clock_get_time</li>
<li>mach_port_deallocate</li>
</ul>

<p><code>host_get_clock_service</code> and <code>mach_port_deallocate</code> usually will be called only
once. We need to value the cost of <code>clock_get_time</code>.
Using <a href="https://github.com/dshil/tb">Benchmarks for time-related operations for OS X and Linux</a> we can see the difference.</p>

<p><code>mach_absolute_time</code>:</p>

<table>
<thead>
<tr>
<th>function name</th>
<th>number of calls</th>
<th>avg (ns/call)</th>
</tr>
</thead>

<tbody>
<tr>
<td>mach_absolute_time</td>
<td>1000</td>
<td>35</td>
</tr>

<tr>
<td>mach_absolute_time</td>
<td>1000000</td>
<td>36</td>
</tr>

<tr>
<td>mach_absolute_time</td>
<td>5000000</td>
<td>37</td>
</tr>
</tbody>
</table>

<p><code>clock_get_time</code>:</p>

<table>
<thead>
<tr>
<th>function name</th>
<th>number of calls</th>
<th>avg (ns/call)</th>
</tr>
</thead>

<tbody>
<tr>
<td>clock_get_time</td>
<td>1000</td>
<td>839</td>
</tr>

<tr>
<td>clock_get_time</td>
<td>1000000</td>
<td>832</td>
</tr>

<tr>
<td>clock_get_time</td>
<td>5000000</td>
<td>813</td>
</tr>
</tbody>
</table>

<p>The cost of system call is important, but it&rsquo;s not a key problem here.</p>

<p>First, let&rsquo;s look at the diagram below to figure out what is performed
underneath. As you remember XNU is all about IPC.</p>

<p><img src="https://dshil.github.io/blog/missed-os-x-clock-guide/host_get_clock_service.png" alt="host_get_clock_service" /></p>

<p>To deal with a clock service you need:</p>

<ul>
<li>Put a port (task_port), where to send the result, in a message.</li>
<li>Send the message to the specified port (clock_service).</li>
<li>The message will be put in the port queue.</li>
<li>Receive clock_port.</li>
</ul>

<p>Kernel allocates a clock_port for us, using which we&rsquo;ll obtain a required
current time.</p>

<p><img src="https://dshil.github.io/blog/missed-os-x-clock-guide/clock_get_time.png" alt="clock_get_time" /></p>

<ul>
<li>Put a port (clock_port), where to send the result, in a message.</li>
<li>Send the message to the specified port (clock_service).</li>
<li>The message will be put in the port queue.</li>
<li>Receive current time.</li>
</ul>

<p><img src="https://dshil.github.io/blog/missed-os-x-clock-guide/mach_port_deallocate.png" alt="mach_port_deallocate" /></p>

<p>When we don&rsquo;t need this port we should deallocate it to avoid a <a href="https://robert.sesek.com/2012/1/debugging_mach_ports.htm://robert.sesek.com/2012/1/debugging_mach_ports.html">port leak
problem</a>.</p>

<p>It seems, that we don&rsquo;t have any problems here, but the devil in the details.
A port is a protected bounded queue. If your system is under a high load, the
queue can be full and we&rsquo;ll need to wait until our message will proceed. We
can meet this problem in each previously mentioned functions. As a result of
our &ldquo;high precision time management&rdquo; will lose a precision.</p>

<h2 id="links">Links</h2>

<ul>
<li><a href="http://web.archive.org/web/20100517095152/http://www.wand.net.nz/~smr26/wordpress/2009/01/19/monotonic-time-in-mac-os-x/comment-page-1/">Monotonic time in Mac OS X</a></li>
<li><a href="https://github.com/joyent/libuv/pull/1325">libuv fight with OS X clock API</a></li>
<li><a href="http://web.archive.org/web/20100501115556/http://le-depotoir.googlecode.com:80/svn/trunk/misc/clock_gettime_stub.c">clock_gettime for OS X</a></li>
<li><a href="http://web.eecs.utk.edu/~qcao1/cs560/papers/mach.pdf">Mach overview</a></li>
<li><a href="https://developer.apple.com/library/content/documentation/Darwin/Conceptual/KernelProgramming/About/About.html">OS X kernel guide lines</a></li>
<li><a href="http://www.osxbook.com">Mac OS X Internals book</a></li>
<li><a href="https://aufather.wordpress.com/2010/09/08/high-performance-time-measuremen-in-linux">RDTSC vs HPET</a></li>
<li><a href="http://linuxmogeb.blogspot.ru/2013/10/how-does-clockgettime-work.html">Linux clock_gettime internals</a></li>
<li><a href="http://aakinshin.net/blog/post/stopwatch/#linux">Timers internals</a></li>
</ul>

                <br>
                
                <p class="back-to-posts"><a href="https://dshil.github.io/blog">Back to posts</a></p>
            </div>
            <br>
            <div class="disqus">
                
            </div>
            
        </div>
    </div>
</section>





  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.11.0/highlight.min.js"></script>
  

  <script type="text/javascript">
    hljs.initHighlightingOnLoad();
  </script>





</body>
</html>

